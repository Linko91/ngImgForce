!function(){var e=angular.module("ngImgForce",[]);e.factory("cropAreaCircle",["cropArea",function(e){var t=function(){e.apply(this,arguments),this._boxResizeBaseSize=30,this._boxResizeNormalRatio=.9,this._boxResizeHoverRatio=1.2,this._iconMoveNormalRatio=.9,this._iconMoveHoverRatio=1.2,this._boxResizeNormalSize=this._boxResizeBaseSize*this._boxResizeNormalRatio,this._boxResizeHoverSize=this._boxResizeBaseSize*this._boxResizeHoverRatio,this._posDragStartX=0,this._posDragStartY=0,this._posResizeStartX=0,this._posResizeStartY=0,this._posResizeStartSize=0,this._boxResizeIsHover=!1,this._areaIsHover=!1,this._boxResizeIsDragging=!1,this._areaIsDragging=!1};return t.prototype=new e,t}]),e.factory("cropAreaRectangle",["cropArea",function(e){var t=function(){e.apply(this,arguments),this._resizeCtrlBaseRadius=15,this._resizeCtrlNormalRatio=.75,this._resizeCtrlHoverRatio=1,this._iconMoveNormalRatio=.9,this._iconMoveHoverRatio=1.2,this._resizeCtrlNormalRadius=this._resizeCtrlBaseRadius*this._resizeCtrlNormalRatio,this._resizeCtrlHoverRadius=this._resizeCtrlBaseRadius*this._resizeCtrlHoverRatio,this._posDragStartX=0,this._posDragStartY=0,this._posResizeStartX=0,this._posResizeStartY=0,this._posResizeStartSize={w:0,h:0},this._resizeCtrlIsHover=-1,this._areaIsHover=!1,this._resizeCtrlIsDragging=-1,this._areaIsDragging=!1};return t.prototype=new e,t.prototype.getType=function(){return"rectangle"},t.prototype._calcRectangleCorners=function(){var e=this.getSize(),t=this.getSouthEastBound();return[[e.x,e.y],[t.x,e.y],[e.x,t.y],[t.x,t.y]]},t.prototype._calcRectangleDimensions=function(){var e=this.getSize(),t=this.getSouthEastBound();return{left:e.x,top:e.y,right:t.x,bottom:t.y}},t.prototype._isCoordWithinArea=function(e){var t=this._calcRectangleDimensions();return e[0]>=t.left&&e[0]<=t.right&&e[1]>=t.top&&e[1]<=t.bottom},t.prototype._isCoordWithinResizeCtrl=function(e){for(var t=this._calcRectangleCorners(),r=-1,n=0,i=t.length;i>n;n++){var o=t[n];if(e[0]>o[0]-this._resizeCtrlHoverRadius&&e[0]<o[0]+this._resizeCtrlHoverRadius&&e[1]>o[1]-this._resizeCtrlHoverRadius&&e[1]<o[1]+this._resizeCtrlHoverRadius){r=n;break}}return r},t.prototype._drawArea=function(e,t,r){e.rect(r.x,r.y,r.w,r.h)},t.prototype.draw=function(){e.prototype.draw.apply(this,arguments);var t=this.getCenterPoint();this._cropCanvas.drawIconMove([t.x,t.y],this._areaIsHover?this._iconMoveHoverRatio:this._iconMoveNormalRatio);for(var r=this._calcRectangleCorners(),n=0,i=r.length;i>n;n++){var o=r[n];this._cropCanvas.drawIconResizeCircle(o,this._resizeCtrlBaseRadius,this._resizeCtrlIsHover===n?this._resizeCtrlHoverRatio:this._resizeCtrlNormalRatio)}},t.prototype.processMouseMove=function(e,t){var r="default",n=!1;return this._resizeCtrlIsHover=-1,this._areaIsHover=!1,this._areaIsDragging?(this.setCenterPoint({x:e-this._posDragStartX,y:t-this._posDragStartY}),this._areaIsHover=!0,r="move",n=!0,this._events.trigger("area-move")):this._resizeCtrlIsDragging>-1,angular.element(this._ctx.canvas).css({cursor:r}),n},t.prototype.processMouseDown=function(e,t){var r=this._isCoordWithinResizeCtrl([e,t]);r>-1||this._isCoordWithinArea([e,t])&&(this._areaIsDragging=!0)},t.prototype.processMouseUp=function(){this._areaIsDragging&&(this._areaIsDragging=!1,this._events.trigger("area-move-end")),this._resizeCtrlIsDragging>-1&&(this._resizeCtrlIsDragging=-1,this._events.trigger("area-resize-end")),this._areaIsHover=!1,this._resizeCtrlIsHover=-1,this._posDragStartX=0,this._posDragStartY=0},t}]),e.factory("cropArea",["cropCanvas",function(e){var t=function(t,r){this._ctx=t,this._events=r,this._minSize={x:0,y:0,w:80,h:80},this._forceAspectRatio=!1,this._aspect=null,this._cropCanvas=new e(t),this._image=new Image,this._size={x:0,y:0,w:150,h:150}};return t.prototype.getImage=function(){return this._image},t.prototype.setImage=function(e){this._image=e},t.prototype.setForceAspectRatio=function(e){this._forceAspectRatio=e},t.prototype.setAspect=function(e){this._aspect=e},t.prototype.getSize=function(){return this._size},t.prototype.setSize=function(e){e=this._processSize(e),this._size=this._preventBoundaryCollision(e)},t.prototype.setSizeByCorners=function(e,t){var r={x:e.x,y:e.y,w:t.x-e.x,h:t.y-e.y};this.setSize(r)},t.prototype.getSouthEastBound=function(){return this._southEastBound(this.getSize())},t.prototype.getMinSize=function(){return this._minSize},t.prototype.getCenterPoint=function(){var e=this.getSize();return{x:e.x+e.w/2,y:e.y+e.h/2}},t.prototype.setCenterPoint=function(e){var t=this.getSize();this.setSize({x:e.x-t.w/2,y:e.y-t.h/2,w:t.w,h:t.h})},t.prototype.setMinSize=function(e){this._minSize=this._processSize(e),this.setSize(this._minSize)},t.prototype.getType=function(){return"circle"},t.prototype._preventBoundaryCollision=function(e){var t=this._ctx.canvas.height,r=this._ctx.canvas.width,n={x:e.x,y:e.y},i=this._southEastBound(e);n.x<0&&(n.x=0),n.y<0&&(n.y=0),i.x>r&&(i.x=r),i.y>t&&(i.y=t);var o=this._forceAspectRatio?e.w:i.x-n.x,a=this._forceAspectRatio?e.h:i.y-n.y;this._aspect&&(o=a*this._aspect,n.x+o>r&&(o=r-n.x,a=o/this._aspect,this._minSize.w>o&&(o=this._minSize.w),this._minSize.h>a&&(a=this._minSize.h),n.x=r-o),n.y+a>t&&(n.y=t-a)),this._forceAspectRatio&&(o=a,n.x+o>r&&(o=r-n.x,o<this._minSize.w&&(o=this._minSize.w),a=o));var s={x:n.x,y:n.y,w:o,h:a};return s.w<this._minSize.w&&!this._forceAspectRatio&&(s.w=this._minSize.w,i=this._southEastBound(s),i.x>r&&(i.x=r,n.x=Math.max(i.x-r,i.x-this._minSize.w),s={x:n.x,y:n.y,w:i.x-n.x,h:i.y-n.y})),s.h<this._minSize.h&&!this._forceAspectRatio&&(s.h=this._minSize.h,i=this._southEastBound(s),i.y>t&&(i.y=t,n.y=Math.max(i.y-t,i.y-this._minSize.h),s={x:n.x,y:n.y,w:i.x-n.x,h:i.y-n.y})),this._forceAspectRatio&&(i=this._southEastBound(s),i.y>t&&(s.y=t-s.h),i.x>r&&(s.x=r-s.w)),s},t.prototype._dontDragOutside=function(){var e=this._ctx.canvas.height,t=this._ctx.canvas.width;this._width>t&&(this._width=t),this._height>e&&(this._height=e),this._x<this._width/2&&(this._x=this._width/2),this._x>t-this._width/2&&(this._x=t-this._width/2),this._y<this._height/2&&(this._y=this._height/2),this._y>e-this._height/2&&(this._y=e-this._height/2)},t.prototype._drawArea=function(){},t.prototype._processSize=function(e){"number"==typeof e&&(e={w:e,h:e});var t=e.w;return this._aspect&&(t=e.h*this._aspect),{x:e.x||this._minSize.x,y:e.y||this._minSize.y,w:t||this._minSize.w,h:e.h||this._minSize.h}},t.prototype._southEastBound=function(e){return{x:e.x+e.w,y:e.y+e.h}},t.prototype.draw=function(){this._cropCanvas.drawCropArea(this._image,this.getCenterPoint(),this._size,this._drawArea)},t.prototype.processMouseMove=function(){},t.prototype.processMouseDown=function(){},t.prototype.processMouseUp=function(){},t}]),e.factory("cropCanvas",[function(){var e=[[-.5,-2],[-3,-4.5],[-.5,-7],[-7,-7],[-7,-.5],[-4.5,-3],[-2,-.5]],t=[[.5,-2],[3,-4.5],[.5,-7],[7,-7],[7,-.5],[4.5,-3],[2,-.5]],r=[[-.5,2],[-3,4.5],[-.5,7],[-7,7],[-7,.5],[-4.5,3],[-2,.5]],n=[[.5,2],[3,4.5],[.5,7],[7,7],[7,.5],[4.5,3],[2,.5]],i=[[-1.5,-2.5],[-1.5,-6],[-5,-6],[0,-11],[5,-6],[1.5,-6],[1.5,-2.5]],o=[[-2.5,-1.5],[-6,-1.5],[-6,-5],[-11,0],[-6,5],[-6,1.5],[-2.5,1.5]],a=[[-1.5,2.5],[-1.5,6],[-5,6],[0,11],[5,6],[1.5,6],[1.5,2.5]],s=[[2.5,-1.5],[6,-1.5],[6,-5],[11,0],[6,5],[6,1.5],[2.5,1.5]],u={areaOutline:"#fff",resizeBoxStroke:"#fff",resizeBoxFill:"#444",resizeBoxArrowFill:"#fff",resizeCircleStroke:"#fff",resizeCircleFill:"#444",moveIconFill:"#fff"};return function(c){var h=function(e,t,r){return[r*e[0]+t[0],r*e[1]+t[1]]},l=function(e,t,r,n){c.save(),c.fillStyle=t,c.beginPath();var i,o=h(e[0],r,n);c.moveTo(o[0],o[1]);for(var a in e)a>0&&(i=h(e[a],r,n),c.lineTo(i[0],i[1]));c.lineTo(o[0],o[1]),c.fill(),c.closePath(),c.restore()};this.drawIconMove=function(e,t){l(i,u.moveIconFill,e,t),l(o,u.moveIconFill,e,t),l(a,u.moveIconFill,e,t),l(s,u.moveIconFill,e,t)},this.drawIconResizeCircle=function(e,t,r){},this.drawIconResizeBoxBase=function(e,t,r){var n=t*r;c.save(),c.strokeStyle=u.resizeBoxStroke,c.lineWidth=2,c.fillStyle=u.resizeBoxFill,c.fillRect(e[0]-n/2,e[1]-n/2,n,n),c.strokeRect(e[0]-n/2,e[1]-n/2,n,n),c.restore()},this.drawIconResizeBoxNESW=function(e,n,i){this.drawIconResizeBoxBase(e,n,i),l(t,u.resizeBoxArrowFill,e,i),l(r,u.resizeBoxArrowFill,e,i)},this.drawIconResizeBoxNWSE=function(t,r,i){this.drawIconResizeBoxBase(t,r,i),l(e,u.resizeBoxArrowFill,t,i),l(n,u.resizeBoxArrowFill,t,i)},this.drawCropArea=function(e,t,r,n){var i=e.width/c.canvas.width,o=e.height/c.canvas.height,a=t.x-r.w/2,s=t.y-r.h/2;c.save(),c.strokeStyle=u.areaOutline,c.lineWidth=2,c.beginPath(),n(c,t,r),c.stroke(),c.clip(),r.w>0&&c.drawImage(e,a*i,s*o,r.w*i,r.h*o,a,s,r.w,r.h),c.beginPath(),n(c,t,r),c.stroke(),c.clip(),c.restore()}}}]),e.service("cropEXIF",[function(){function e(e){return!!e.exifdata}function t(e,t){t=t||e.match(/^data\:([^\;]+)\;base64,/im)[1]||"",e=e.replace(/^data\:([^\;]+)\;base64,/gim,"");for(var r=atob(e),n=r.length,i=new ArrayBuffer(n),o=new Uint8Array(i),a=0;n>a;a++)o[a]=r.charCodeAt(a);return i}function r(e,t){var r=new XMLHttpRequest;r.open("GET",e,!0),r.responseType="blob",r.onload=function(e){(200==this.status||0===this.status)&&t(this.response)},r.send()}function n(e,n){function a(t){var r=i(t),a=o(t);e.exifdata=r||{},e.iptcdata=a||{},n&&n.call(e)}if(e.src)if(/^data\:/i.test(e.src)){var s=t(e.src);a(s)}else if(/^blob\:/i.test(e.src)){var u=new FileReader;u.onload=function(e){a(e.target.result)},r(e.src,function(e){u.readAsArrayBuffer(e)})}else{var c=new XMLHttpRequest;c.onload=function(){if(200!=this.status&&0!==this.status)throw"Could not load image";a(c.response),c=null},c.open("GET",e.src,!0),c.responseType="arraybuffer",c.send(null)}else if(window.FileReader&&(e instanceof window.Blob||e instanceof window.File)){var u=new FileReader;u.onload=function(e){l&&console.log("Got file of length "+e.target.result.byteLength),a(e.target.result)},u.readAsArrayBuffer(e)}}function i(e){var t=new DataView(e);if(l&&console.log("Got file of length "+e.byteLength),255!=t.getUint8(0)||216!=t.getUint8(1))return l&&console.log("Not a valid JPEG"),!1;for(var r,n=2,i=e.byteLength;i>n;){if(255!=t.getUint8(n))return l&&console.log("Not a valid marker at offset "+n+", found: "+t.getUint8(n)),!1;if(r=t.getUint8(n+1),l&&console.log(r),225==r)return l&&console.log("Found 0xFFE1 marker"),h(t,n+4,t.getUint16(n+2)-2);n+=2+t.getUint16(n+2)}}function o(e){var t=new DataView(e);if(l&&console.log("Got file of length "+e.byteLength),255!=t.getUint8(0)||216!=t.getUint8(1))return l&&console.log("Not a valid JPEG"),!1;for(var r=2,n=e.byteLength,i=function(e,t){return 56===e.getUint8(t)&&66===e.getUint8(t+1)&&73===e.getUint8(t+2)&&77===e.getUint8(t+3)&&4===e.getUint8(t+4)&&4===e.getUint8(t+5)};n>r;){if(i(t,r)){var o=t.getUint8(r+7);o%2!==0&&(o+=1),0===o&&(o=4);var s=r+8+o,u=t.getUint16(r+6+o);return a(e,s,u)}r++}}function a(e,t,r){for(var n,i,o,a,s,u=new DataView(e),h={},l=t;t+r>l;)28===u.getUint8(l)&&2===u.getUint8(l+1)&&(a=u.getUint8(l+2),a in m&&(o=u.getInt16(l+3),s=o+5,i=m[a],n=c(u,l+5,o),h.hasOwnProperty(i)?h[i]instanceof Array?h[i].push(n):h[i]=[h[i],n]:h[i]=n)),l++;return h}function s(e,t,r,n,i){var o,a,s,c=e.getUint16(r,!i),h={};for(s=0;c>s;s++)o=r+12*s+2,a=n[e.getUint16(o,!i)],!a&&l&&console.log("Unknown tag: "+e.getUint16(o,!i)),h[a]=u(e,o,t,r,i);return h}function u(e,t,r,n,i){var o,a,s,u,h,l,g=e.getUint16(t+2,!i),f=e.getUint32(t+4,!i),d=e.getUint32(t+8,!i)+r;switch(g){case 1:case 7:if(1==f)return e.getUint8(t+8,!i);for(o=f>4?d:t+8,a=[],u=0;f>u;u++)a[u]=e.getUint8(o+u);return a;case 2:return o=f>4?d:t+8,c(e,o,f-1);case 3:if(1==f)return e.getUint16(t+8,!i);for(o=f>2?d:t+8,a=[],u=0;f>u;u++)a[u]=e.getUint16(o+2*u,!i);return a;case 4:if(1==f)return e.getUint32(t+8,!i);for(a=[],u=0;f>u;u++)a[u]=e.getUint32(d+4*u,!i);return a;case 5:if(1==f)return h=e.getUint32(d,!i),l=e.getUint32(d+4,!i),s=new Number(h/l),s.numerator=h,s.denominator=l,s;for(a=[],u=0;f>u;u++)h=e.getUint32(d+8*u,!i),l=e.getUint32(d+4+8*u,!i),a[u]=new Number(h/l),a[u].numerator=h,a[u].denominator=l;return a;case 9:if(1==f)return e.getInt32(t+8,!i);for(a=[],u=0;f>u;u++)a[u]=e.getInt32(d+4*u,!i);return a;case 10:if(1==f)return e.getInt32(d,!i)/e.getInt32(d+4,!i);for(a=[],u=0;f>u;u++)a[u]=e.getInt32(d+8*u,!i)/e.getInt32(d+4+8*u,!i);return a}}function c(e,t,r){for(var n="",i=t;t+r>i;i++)n+=String.fromCharCode(e.getUint8(i));return n}function h(e,t){if("Exif"!=c(e,t,4))return l&&console.log("Not valid EXIF data! "+c(e,t,4)),!1;var r,n,i,o,a,u=t+6;if(18761==e.getUint16(u))r=!1;else{if(19789!=e.getUint16(u))return l&&console.log("Not valid TIFF data! (no 0x4949 or 0x4D4D)"),!1;r=!0}if(42!=e.getUint16(u+2,!r))return l&&console.log("Not valid TIFF data! (no 0x002A)"),!1;var h=e.getUint32(u+4,!r);if(8>h)return l&&console.log("Not valid TIFF data! (First offset less than 8)",e.getUint32(u+4,!r)),!1;if(n=s(e,u,u+h,f,r),n.ExifIFDPointer){o=s(e,u,u+n.ExifIFDPointer,g,r);for(i in o){switch(i){case"LightSource":case"Flash":case"MeteringMode":case"ExposureProgram":case"SensingMethod":case"SceneCaptureType":case"SceneType":case"CustomRendered":case"WhiteBalance":case"GainControl":case"Contrast":case"Saturation":case"Sharpness":case"SubjectDistanceRange":case"FileSource":o[i]=p[i][o[i]];break;case"ExifVersion":case"FlashpixVersion":o[i]=String.fromCharCode(o[i][0],o[i][1],o[i][2],o[i][3]);break;case"ComponentsConfiguration":o[i]=p.Components[o[i][0]]+p.Components[o[i][1]]+p.Components[o[i][2]]+p.Components[o[i][3]]}n[i]=o[i]}}if(n.GPSInfoIFDPointer){a=s(e,u,u+n.GPSInfoIFDPointer,d,r);for(i in a){switch(i){case"GPSVersionID":a[i]=a[i][0]+"."+a[i][1]+"."+a[i][2]+"."+a[i][3]}n[i]=a[i]}}return n}var l=!1,g=this.Tags={36864:"ExifVersion",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37500:"MakerNote",37510:"UserComment",40964:"RelatedSoundFile",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBias",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37396:"SubjectArea",37386:"FocalLength",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRation",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",40965:"InteroperabilityIFDPointer",42016:"ImageUniqueID"},f=this.TiffTags={256:"ImageWidth",257:"ImageHeight",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer",40965:"InteroperabilityIFDPointer",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",274:"Orientation",277:"SamplesPerPixel",284:"PlanarConfiguration",530:"YCbCrSubSampling",531:"YCbCrPositioning",282:"XResolution",283:"YResolution",296:"ResolutionUnit",273:"StripOffsets",278:"RowsPerStrip",279:"StripByteCounts",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",301:"TransferFunction",318:"WhitePoint",319:"PrimaryChromaticities",529:"YCbCrCoefficients",532:"ReferenceBlackWhite",306:"DateTime",270:"ImageDescription",271:"Make",272:"Model",305:"Software",315:"Artist",33432:"Copyright"},d=this.GPSTags={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential"},p=this.StringValues={ExposureProgram:{0:"Not defined",1:"Manual",2:"Normal program",3:"Aperture priority",4:"Shutter priority",5:"Creative program",6:"Action program",7:"Portrait mode",8:"Landscape mode"},MeteringMode:{0:"Unknown",1:"Average",2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"},LightSource:{0:"Unknown",1:"Daylight",2:"Fluorescent",3:"Tungsten (incandescent light)",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 - 5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",24:"ISO studio tungsten",255:"Other"},Flash:{0:"Flash did not fire",1:"Flash fired",5:"Strobe return light not detected",7:"Strobe return light detected",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",95:"Flash fired, auto mode, return light detected, red-eye reduction mode"},SensingMethod:{1:"Not defined",2:"One-chip color area sensor",3:"Two-chip color area sensor",4:"Three-chip color area sensor",5:"Color sequential area sensor",7:"Trilinear sensor",8:"Color sequential linear sensor"},SceneCaptureType:{0:"Standard",1:"Landscape",2:"Portrait",3:"Night scene"},SceneType:{1:"Directly photographed"},CustomRendered:{0:"Normal process",1:"Custom process"},WhiteBalance:{0:"Auto white balance",1:"Manual white balance"},GainControl:{0:"None",1:"Low gain up",2:"High gain up",3:"Low gain down",4:"High gain down"},Contrast:{0:"Normal",1:"Soft",2:"Hard"},Saturation:{0:"Normal",1:"Low saturation",2:"High saturation"},Sharpness:{0:"Normal",1:"Soft",2:"Hard"},SubjectDistanceRange:{0:"Unknown",1:"Macro",2:"Close view",3:"Distant view"},FileSource:{3:"DSC"},Components:{0:"",1:"Y",2:"Cb",3:"Cr",4:"R",5:"G",6:"B"}},m={120:"caption",110:"credit",25:"keywords",55:"dateCreated",80:"byline",85:"bylineTitle",122:"captionWriter",105:"headline",116:"copyright",15:"category"};this.getData=function(t,r){return(t instanceof Image||t instanceof HTMLImageElement)&&!t.complete?!1:(e(t)?r&&r.call(t):n(t,r),!0)},this.getTag=function(t,r){return e(t)?t.exifdata[r]:void 0},this.getAllTags=function(t){if(!e(t))return{};var r,n=t.exifdata,i={};for(r in n)n.hasOwnProperty(r)&&(i[r]=n[r]);return i},this.pretty=function(t){if(!e(t))return"";var r,n=t.exifdata,i="";for(r in n)n.hasOwnProperty(r)&&(i+="object"==typeof n[r]?n[r]instanceof Number?r+" : "+n[r]+" ["+n[r].numerator+"/"+n[r].denominator+"]\r\n":r+" : ["+n[r].length+" values]\r\n":r+" : "+n[r]+"\r\n");return i},this.readFromBinaryFile=function(e){return i(e)}}]),e.factory("cropHost",["$document","$q","cropAreaCircle","cropAreaRectangle","cropEXIF",function(e,t,r,n,i){var o=function(e){var t=e.getBoundingClientRect(),r=document.body,n=document.documentElement,i=window.pageYOffset||n.scrollTop||r.scrollTop,o=window.pageXOffset||n.scrollLeft||r.scrollLeft,a=n.clientTop||r.clientTop||0,s=n.clientLeft||r.clientLeft||0,u=t.top+i-a,c=t.left+o-s;return{top:Math.round(u),left:Math.round(c)}};return function(a,s,u){function c(){h.clearRect(0,0,h.canvas.width,h.canvas.height),null!==l&&(h.drawImage(l,0,0,h.canvas.width,h.canvas.height),h.save(),h.fillStyle="rgba(0, 0, 0, 0.65)",h.fillRect(0,0,h.canvas.width,h.canvas.height),h.restore(),g.draw())}var h=null,l=null,g=null,f=this,d=[100,100],p=[300,300],m=[];resImgSize={w:200,h:200},resImgFormat="image/png",resImgQuality=null,forceAspectRatio=!1;var v=function(){if(null!==l){g.setImage(l);var e=[l.width,l.height],t=l.width/l.height,r=e;r[0]>p[0]?(r[0]=p[0],r[1]=r[0]/t):r[0]<d[0]&&(r[0]=d[0],r[1]=r[0]/t),r[1]>p[1]?(r[1]=p[1],r[0]=r[1]*t):r[1]<d[1]&&(r[1]=d[1],r[0]=r[1]*t),a.prop("width",r[0]).prop("height",r[1]).css({"margin-left":-r[0]/2+"px","margin-top":-r[1]/2+"px"});var n=h.canvas.width,i=h.canvas.height,o=f.getAreaType();("circle"===o||"square"===o)&&(i=n),g.setSize({w:Math.min(200,n/2),h:Math.min(200,i/2)}),g.setCenterPoint({x:h.canvas.width/2,y:h.canvas.height/2})}else a.prop("width",0).prop("height",0).css({"margin-top":0});c()},w=function(e){return angular.isDefined(e.changedTouches)?e.changedTouches:e.originalEvent.changedTouches},S=function(e){if(null!==l){var t,r,n=o(h.canvas);"touchmove"===e.type?(t=w(e)[0].pageX,r=w(e)[0].pageY):(t=e.pageX,r=e.pageY),g.processMouseMove(t-n.left,r-n.top),c()}},y=function(e){if(e.preventDefault(),e.stopPropagation(),null!==l){var t,r,n=o(h.canvas);"touchstart"===e.type?(t=w(e)[0].pageX,r=w(e)[0].pageY):(t=e.pageX,r=e.pageY),g.processMouseDown(t-n.left,r-n.top),c()}},b=function(e){if(null!==l){var t,r,n=o(h.canvas);"touchend"===e.type?(t=w(e)[0].pageX,r=w(e)[0].pageY):(t=e.pageX,r=e.pageY),g.processMouseUp(t-n.left,r-n.top),c()}},x=function(e){var t,r,n=e,i=g.getCenterPoint(),o={dataURI:null,imageData:null};if(r=angular.element("<canvas></canvas>")[0],t=r.getContext("2d"),r.width=n.w,r.height=n.h,null!==l){var a=(i.x-g.getSize().w/2)*(l.width/h.canvas.width),s=(i.y-g.getSize().h/2)*(l.height/h.canvas.height),u=g.getSize().w*(l.width/h.canvas.width),c=g.getSize().h*(l.height/h.canvas.height);if(forceAspectRatio)t.drawImage(l,a,s,u,c,0,0,n.w,n.h);else{var f,d,p=u/c;p>1?(d=n.w,f=d/p):(f=n.h,d=f*p),t.drawImage(l,a,s,u,c,0,0,Math.round(d),Math.round(f))}null!==resImgQuality?o.dataURI=r.toDataURL(resImgFormat,resImgQuality):o.dataURI=r.toDataURL(resImgFormat)}return o};this.getResultImage=function(){if(0==m.length)return x(this.getResultImageSize());for(var e=[],t=0;t<m.length;t++)e.push({dataURI:x(m[t]).dataURI,w:m[t].w,h:m[t].h});return e},this.getResultImageDataBlob=function(){var e,r,n,i=g.getCenterPoint(),o=this.getResultImageSize(),n=t.defer();if(r=angular.element("<canvas></canvas>")[0],e=r.getContext("2d"),r.width=o.w,r.height=o.h,null!==l){var a=(i.x-g.getSize().w/2)*(l.width/h.canvas.width),s=(i.y-g.getSize().h/2)*(l.height/h.canvas.height),u=g.getSize().w*(l.width/h.canvas.width),c=g.getSize().h*(l.height/h.canvas.height);if(forceAspectRatio)e.drawImage(l,a,s,u,c,0,0,o.w,o.h);else{var f,d,p=u/c;p>1?(d=o.w,f=d/p):(f=o.h,d=f*p),e.drawImage(l,a,s,u,c,0,0,Math.round(d),Math.round(f))}}return r.toBlob(function(e){n.resolve(e)}),n.promise},this.getAreaCoords=function(){return g.getSize()},this.setNewImageSource=function(e){if(l=null,v(),u.trigger("image-updated"),e){var t=new Image;t.crossOrigin="anonymous",t.onload=function(){u.trigger("load-done"),i.getData(t,function(){var e=i.getTag(t,"Orientation");if([3,6,8].indexOf(e)>-1){var r=document.createElement("canvas"),n=r.getContext("2d"),o=t.width,a=t.height,s=0,c=0,h=0,g=0,f=0;switch(g=o,f=a,e){case 3:s=-t.width,c=-t.height,h=180;break;case 6:o=t.height,a=t.width,c=-t.height,h=90;break;case 8:o=t.height,a=t.width,s=-t.width,h=270}var d=1e3;if(o>d||a>d){var p=0;o>d?(p=d/o,o=d,a=p*a):a>d&&(p=d/a,a=d,o=p*o),c=p*c,s=p*s,g=p*g,f=p*f}r.width=o,r.height=a,n.rotate(h*Math.PI/180),n.drawImage(t,s,c,g,f),l=new Image,l.src=r.toDataURL(resImgFormat)}else l=t;v(),u.trigger("image-updated")})},t.onerror=function(){u.trigger("load-error")},u.trigger("load-start"),e instanceof window.Blob?t.src=URL.createObjectURL(e):t.src=e}},this.setMaxDimensions=function(e,t){if(p=[e,t],null!==l){var r=h.canvas.width,n=h.canvas.height,i=[l.width,l.height],o=l.width/l.height,s=i;s[0]>p[0]?(s[0]=p[0],s[1]=s[0]/o):s[0]<d[0]&&(s[0]=d[0],s[1]=s[0]/o),s[1]>p[1]?(s[1]=p[1],s[0]=s[1]*o):s[1]<d[1]&&(s[1]=d[1],s[0]=s[1]*o),a.prop("width",s[0]).prop("height",s[1]).css({"margin-left":-s[0]/2+"px","margin-top":-s[1]/2+"px"});var u=h.canvas.width/r,f=h.canvas.height/n,m=Math.min(u,f);g.setSize({w:g.getSize().w*m,h:g.getSize().h*m});var v=g.getCenterPoint();g.setCenterPoint({x:v.x*u,y:v.y*f})}else a.prop("width",0).prop("height",0).css({"margin-top":0});c()},this.setAreaMinSize=function(e){angular.isUndefined(e)||(e="number"==typeof e||"string"==typeof e?{w:parseInt(parseInt(e),10),h:parseInt(parseInt(e),10)}:{w:parseInt(e.w,10),h:parseInt(e.h,10)},isNaN(e.w)||isNaN(e.h)||(g.setMinSize(e),c()))},this.getResultImageSize=function(){if("selection"==resImgSize)return g.getSize();if("max"==resImgSize){var e=1;l&&h&&h.canvas&&(e=l.width/h.canvas.width);var t={w:e*g.getSize().w,h:e*g.getSize().h};return t}return resImgSize},this.setResultImageSize=function(e){if(angular.isArray(e))return m=e.slice(),void(e={w:parseInt(e[0].w,10),h:parseInt(e[0].h,10)});if(!angular.isUndefined(e)){if(angular.isString(e))return void(resImgSize=e);angular.isNumber(e)&&(e=parseInt(e,10),e={w:e,h:e}),e={w:parseInt(e.w,10),h:parseInt(e.h,10)},isNaN(e.w)||isNaN(e.h)||(resImgSize=e,c())}},this.setResultImageFormat=function(e){resImgFormat=e},this.setResultImageQuality=function(e){e=parseFloat(e),!isNaN(e)&&e>=0&&1>=e&&(resImgQuality=e)},this.getAreaType=function(){return g.getType()},this.setAreaType=function(e){var t=g.getCenterPoint(),i=g.getSize(),o=g.getMinSize(),a=t.x,s=t.y,f=r;"square"===e?f=CropAreaSquare:"rectangle"===e&&(f=n),g=new f(h,u),g.setMinSize(o),g.setSize(i),"square"===e||"circle"===e?(forceAspectRatio=!0,g.setForceAspectRatio(!0)):(forceAspectRatio=!1,g.setForceAspectRatio(!1)),g.setCenterPoint({x:a,y:s}),null!==l&&g.setImage(l),c()},this.getDominantColor=function(e){var r=new Image,n=new ColorThief,i=null,o=t.defer();return r.src=e,r.onload=function(){i=n.getColor(r),o.resolve(i)},o.promise},this.getPalette=function(e){var r=new Image,n=new ColorThief,i=null,o=t.defer();return r.src=e,r.onload=function(){i=n.getPalette(r,colorPaletteLength),o.resolve(i)},o.promise},this.setPaletteColorLength=function(e){colorPaletteLength=e},this.setAspect=function(e){g.setAspect(e);var t=g.getMinSize();t.w=t.h*e,g.setMinSize(t);var r=g.getSize();r.w=r.h*e,g.setSize(r)},h=a[0].getContext("2d"),g=new r(h,u),e.on("mousemove",S),a.on("mousedown",y),e.on("mouseup",b),e.on("touchmove",S),a.on("touchstart",y),e.on("touchend",b),this.destroy=function(){e.off("mousemove",S),a.off("mousedown",y),e.off("mouseup",S),e.off("touchmove",S),a.off("touchstart",y),e.off("touchend",S),a.remove()}}}]),e.factory("cropPubSub",[function(){return function(){var e={};this.on=function(t,r){return t.split(" ").forEach(function(t){e[t]||(e[t]=[]),e[t].push(r)}),this},this.trigger=function(t,r){return angular.forEach(e[t],function(e){e.call(null,r)}),this}}}]),e.directive("imgForce",["$timeout","cropHost","cropPubSub",function(e,t,r){return{restrict:"E",scope:{image:"=",resultImage:"=",resultArrayImage:"=",resultBlob:"=",urlBlob:"=",chargement:"=",changeOnFly:"=",areaCoords:"=",areaType:"@",areaMinSize:"=",resultImageSize:"=",resultImageFormat:"=",resultImageQuality:"=",aspectRatio:"=",dominantColor:"=",paletteColor:"=",paletteColorLength:"=",onChange:"&",onLoadBegin:"&",onLoadDone:"&",onLoadError:"&"},template:"<canvas></canvas>",controller:["$scope",function(e){e.events=new r}],link:function(r,n){var i,o=r.events,a=new t(n.find("canvas"),{},o),s=function(e){if(""!==e.image){var t=a.getResultImage();if(angular.isArray(t))r=t[0].dataURI,e.resultArrayImage=t;else var r=t.dataURI;var n=window.URL||window.webkitURL;i!==r&&(i=r,e.resultImage=r,a.getResultImageDataBlob().then(function(t){e.resultBlob=t,e.urlBlob=n.createObjectURL(t)}),a.getDominantColor(e.resultImage).then(function(t){e.dominantColor=t}),a.getPalette(e.resultImage).then(function(t){e.paletteColor=t}),u(e),e.onChange({$dataURI:e.resultImage}))}},u=function(e){var t=a.getAreaCoords();e.areaCoords=t},c=function(t){return function(){e(function(){r.$apply(function(e){t(e)})})}};null==r.chargement&&(r.chargement="Chargement");var h=function(){n.append('<div class="loading"><span>'+r.chargement+"...</span></div>")};o.on("load-start",c(function(e){e.onLoadBegin({})})).on("load-done",c(function(e){angular.element(n.children()[n.children().length-1]).remove(),e.onLoadDone({})})).on("load-error",c(function(e){e.onLoadError({})})).on("area-move area-resize",c(function(e){e.changeOnFly&&s(e)})).on("area-move-end area-resize-end image-updated",c(function(e){s(e)})),r.$watch("image",function(t){t&&h(),e(function(){a.setNewImageSource(r.image)},100)}),r.$watch("areaType",function(){a.setAreaType("rectangle"),s(r)}),r.$watch("areaMinSize",function(){}),r.$watch("resultImageFormat",function(){a.setResultImageFormat(r.resultImageFormat),s(r)}),r.$watch("resultImageQuality",function(){a.setResultImageQuality(r.resultImageQuality),s(r)}),r.$watch("resultImageSize",function(){a.setResultImageSize(r.resultImageSize),s(r)}),r.$watch("paletteColorLength",function(){a.setPaletteColorLength(r.paletteColorLength)}),r.$watch("aspectRatio",function(){var e=r.resultImageSize.w/r.resultImageSize.h;a.setAspect(e)}),r.$watch(function(){return[n[0].clientWidth,n[0].clientHeight]},function(e){a.setMaxDimensions(e[0],e[1]),s(r)},!0),r.$on("$destroy",function(){a.destroy()})}}}]),function(e){"use strict";var t,r=e.Uint8Array,n=e.HTMLCanvasElement,i=n&&n.prototype,o=/\s*;\s*base64\s*(?:;|$)/i,a="toDataURL",s=function(e){for(var n,i,o,a=e.length,s=new r(a/4*3|0),u=0,c=0,h=[0,0],l=0,g=0;a--;)i=e.charCodeAt(u++),n=t[i-43],255!==n&&n!==o&&(h[1]=h[0],h[0]=i,g=g<<6|n,l++,4===l&&(s[c++]=g>>>16,61!==h[1]&&(s[c++]=g>>>8),61!==h[0]&&(s[c++]=g),l=0));return s};r&&(t=new r([62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51])),n&&!i.toBlob&&(i.toBlob=function(e,t){if(t||(t="image/png"),this.mozGetAsFile)return void e(this.mozGetAsFile("canvas",t));if(this.msToBlob&&/^\s*image\/png\s*(?:$|;)/i.test(t))return void e(this.msToBlob());var n,i=Array.prototype.slice.call(arguments,1),u=this[a].apply(this,i),c=u.indexOf(","),h=u.substring(c+1),l=o.test(u.substring(0,c));Blob.fake?(n=new Blob,l?n.encoding="base64":n.encoding="URI",n.data=h,n.size=h.length):r&&(n=l?new Blob([s(h)],{type:t}):new Blob([decodeURIComponent(h)],{type:t})),"undefined"!=typeof e&&e(n)},i.toDataURLHD?i.toBlobHD=function(){a="toDataURLHD";var e=this.toBlob();return a="toDataURL",e}:i.toBlobHD=i.toBlob)}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content||this),function(){var e=function(e){this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),document.body.appendChild(this.canvas),this.width=this.canvas.width=e.width,this.height=this.canvas.height=e.height,this.context.drawImage(e,0,0,this.width,this.height)};e.prototype.clear=function(){this.context.clearRect(0,0,this.width,this.height)},e.prototype.update=function(e){this.context.putImageData(e,0,0)},e.prototype.getPixelCount=function(){return this.width*this.height},e.prototype.getImageData=function(){return this.context.getImageData(0,0,this.width,this.height)},e.prototype.removeCanvas=function(){this.canvas.parentNode.removeChild(this.canvas)};var t=function(){};if(t.prototype.getColor=function(e,t){
var r=this.getPalette(e,5,t),n=r[0];return n},t.prototype.getPalette=function(t,r,i){"undefined"==typeof r&&(r=10),("undefined"==typeof i||1>i)&&(i=10);for(var o,a,s,u,c,h=new e(t),l=h.getImageData(),g=l.data,f=h.getPixelCount(),d=[],p=0;f>p;p+=i)o=4*p,a=g[o+0],s=g[o+1],u=g[o+2],c=g[o+3],c>=125&&(a>250&&s>250&&u>250||d.push([a,s,u]));var m=n.quantize(d,r),v=m?m.palette():null;return h.removeCanvas(),v},!r)var r={map:function(e,t){var r={};return t?e.map(function(e,n){return r.index=n,t.call(r,e)}):e.slice()},naturalOrder:function(e,t){return t>e?-1:e>t?1:0},sum:function(e,t){var r={};return e.reduce(t?function(e,n,i){return r.index=i,e+t.call(r,n)}:function(e,t){return e+t},0)},max:function(e,t){return Math.max.apply(null,t?r.map(e,t):e)}};var n=function(){function e(e,t,r){return(e<<2*c)+(t<<c)+r}function t(e){function t(){r.sort(e),n=!0}var r=[],n=!1;return{push:function(e){r.push(e),n=!1},peek:function(e){return n||t(),void 0===e&&(e=r.length-1),r[e]},pop:function(){return n||t(),r.pop()},size:function(){return r.length},map:function(e){return r.map(e)},debug:function(){return n||t(),r}}}function n(e,t,r,n,i,o,a){var s=this;s.r1=e,s.r2=t,s.g1=r,s.g2=n,s.b1=i,s.b2=o,s.histo=a}function i(){this.vboxes=new t(function(e,t){return r.naturalOrder(e.vbox.count()*e.vbox.volume(),t.vbox.count()*t.vbox.volume())})}function o(t){var r,n,i,o,a=1<<3*c,s=new Array(a);return t.forEach(function(t){n=t[0]>>h,i=t[1]>>h,o=t[2]>>h,r=e(n,i,o),s[r]=(s[r]||0)+1}),s}function a(e,t){var r,i,o,a=1e6,s=0,u=1e6,c=0,l=1e6,g=0;return e.forEach(function(e){r=e[0]>>h,i=e[1]>>h,o=e[2]>>h,a>r?a=r:r>s&&(s=r),u>i?u=i:i>c&&(c=i),l>o?l=o:o>g&&(g=o)}),new n(a,s,u,c,l,g,t)}function s(t,n){function i(e){var t,r,i,o,a,s=e+"1",u=e+"2",h=0;for(c=n[s];c<=n[u];c++)if(p[c]>d/2){for(i=n.copy(),o=n.copy(),t=c-n[s],r=n[u]-c,a=r>=t?Math.min(n[u]-1,~~(c+r/2)):Math.max(n[s],~~(c-1-t/2));!p[a];)a++;for(h=m[a];!h&&p[a-1];)h=m[--a];return i[u]=a,o[s]=i[u]+1,[i,o]}}if(n.count()){var o=n.r2-n.r1+1,a=n.g2-n.g1+1,s=n.b2-n.b1+1,u=r.max([o,a,s]);if(1==n.count())return[n.copy()];var c,h,l,g,f,d=0,p=[],m=[];if(u==o)for(c=n.r1;c<=n.r2;c++){for(g=0,h=n.g1;h<=n.g2;h++)for(l=n.b1;l<=n.b2;l++)f=e(c,h,l),g+=t[f]||0;d+=g,p[c]=d}else if(u==a)for(c=n.g1;c<=n.g2;c++){for(g=0,h=n.r1;h<=n.r2;h++)for(l=n.b1;l<=n.b2;l++)f=e(h,c,l),g+=t[f]||0;d+=g,p[c]=d}else for(c=n.b1;c<=n.b2;c++){for(g=0,h=n.r1;h<=n.r2;h++)for(l=n.g1;l<=n.g2;l++)f=e(h,l,c),g+=t[f]||0;d+=g,p[c]=d}return p.forEach(function(e,t){m[t]=d-e}),i(u==o?"r":u==a?"g":"b")}}function u(e,n){function u(e,t){for(var r,n=1,i=0;l>i;)if(r=e.pop(),r.count()){var o=s(c,r),a=o[0],u=o[1];if(!a)return;if(e.push(a),u&&(e.push(u),n++),n>=t)return;if(i++>l)return}else e.push(r),i++}if(!e.length||2>n||n>256)return!1;var c=o(e),h=0;c.forEach(function(){h++});var f=a(e,c),d=new t(function(e,t){return r.naturalOrder(e.count(),t.count())});d.push(f),u(d,g*n);for(var p=new t(function(e,t){return r.naturalOrder(e.count()*e.volume(),t.count()*t.volume())});d.size();)p.push(d.pop());u(p,n-p.size());for(var m=new i;p.size();)m.push(p.pop());return m}var c=5,h=8-c,l=1e3,g=.75;return n.prototype={volume:function(e){var t=this;return(!t._volume||e)&&(t._volume=(t.r2-t.r1+1)*(t.g2-t.g1+1)*(t.b2-t.b1+1)),t._volume},count:function(t){var r=this,n=r.histo;if(!r._count_set||t){var i,o,a,s=0;for(i=r.r1;i<=r.r2;i++)for(o=r.g1;o<=r.g2;o++)for(a=r.b1;a<=r.b2;a++)index=e(i,o,a),s+=n[index]||0;r._count=s,r._count_set=!0}return r._count},copy:function(){var e=this;return new n(e.r1,e.r2,e.g1,e.g2,e.b1,e.b2,e.histo)},avg:function(t){var r=this,n=r.histo;if(!r._avg||t){var i,o,a,s,u,h=0,l=1<<8-c,g=0,f=0,d=0;for(o=r.r1;o<=r.r2;o++)for(a=r.g1;a<=r.g2;a++)for(s=r.b1;s<=r.b2;s++)u=e(o,a,s),i=n[u]||0,h+=i,g+=i*(o+.5)*l,f+=i*(a+.5)*l,d+=i*(s+.5)*l;h?r._avg=[~~(g/h),~~(f/h),~~(d/h)]:r._avg=[~~(l*(r.r1+r.r2+1)/2),~~(l*(r.g1+r.g2+1)/2),~~(l*(r.b1+r.b2+1)/2)]}return r._avg},contains:function(e){var t=this,r=e[0]>>h;return gval=e[1]>>h,bval=e[2]>>h,r>=t.r1&&r<=t.r2&&gval>=t.g1&&gval<=t.g2&&bval>=t.b1&&bval<=t.b2}},i.prototype={push:function(e){this.vboxes.push({vbox:e,color:e.avg()})},palette:function(){return this.vboxes.map(function(e){return e.color})},size:function(){return this.vboxes.size()},map:function(e){for(var t=this.vboxes,r=0;r<t.size();r++)if(t.peek(r).vbox.contains(e))return t.peek(r).color;return this.nearest(e)},nearest:function(e){for(var t,r,n,i=this.vboxes,o=0;o<i.size();o++)r=Math.sqrt(Math.pow(e[0]-i.peek(o).color[0],2)+Math.pow(e[1]-i.peek(o).color[1],2)+Math.pow(e[2]-i.peek(o).color[2],2)),(t>r||void 0===t)&&(t=r,n=i.peek(o).color);return n},forcebw:function(){var e=this.vboxes;e.sort(function(e,t){return r.naturalOrder(r.sum(e.color),r.sum(t.color))});var t=e[0].color;t[0]<5&&t[1]<5&&t[2]<5&&(e[0].color=[0,0,0]);var n=e.length-1,i=e[n].color;i[0]>251&&i[1]>251&&i[2]>251&&(e[n].color=[255,255,255])}},{quantize:u}}();"function"==typeof define&&define.amd?define([],function(){return t}):"object"==typeof exports?module.exports=t:this.ColorThief=t}.call(this)}(),function(){function e(e){return!!e.exifdata}function t(e,t){t=t||e.match(/^data\:([^\;]+)\;base64,/im)[1]||"",e=e.replace(/^data\:([^\;]+)\;base64,/gim,"");for(var r=atob(e),n=r.length,i=new ArrayBuffer(n),o=new Uint8Array(i),a=0;n>a;a++)o[a]=r.charCodeAt(a);return i}function r(e,t){var r=new XMLHttpRequest;r.open("GET",e,!0),r.responseType="blob",r.onload=function(e){(200==this.status||0===this.status)&&t(this.response)},r.send()}function i(e,n){function i(t){var r=o(t),i=a(t);e.exifdata=r||{},e.iptcdata=i||{},n&&n.call(e)}if(e.src)if(/^data\:/i.test(e.src)){var s=t(e.src);i(s)}else if(/^blob\:/i.test(e.src)){var u=new FileReader;u.onload=function(e){i(e.target.result)},r(e.src,function(e){u.readAsArrayBuffer(e)})}else{var c=new XMLHttpRequest;c.onload=function(){if(200!=this.status&&0!==this.status)throw"Could not load image";i(c.response),c=null},c.open("GET",e.src,!0),c.responseType="arraybuffer",c.send(null)}else if(window.FileReader&&(e instanceof window.Blob||e instanceof window.File)){var u=new FileReader;u.onload=function(e){g&&console.log("Got file of length "+e.target.result.byteLength),i(e.target.result)},u.readAsArrayBuffer(e)}}function o(e){var t=new DataView(e);if(g&&console.log("Got file of length "+e.byteLength),255!=t.getUint8(0)||216!=t.getUint8(1))return g&&console.log("Not a valid JPEG"),!1;for(var r,n=2,i=e.byteLength;i>n;){if(255!=t.getUint8(n))return g&&console.log("Not a valid marker at offset "+n+", found: "+t.getUint8(n)),!1;if(r=t.getUint8(n+1),g&&console.log(r),225==r)return g&&console.log("Found 0xFFE1 marker"),l(t,n+4,t.getUint16(n+2)-2);n+=2+t.getUint16(n+2)}}function a(e){var t=new DataView(e);if(g&&console.log("Got file of length "+e.byteLength),255!=t.getUint8(0)||216!=t.getUint8(1))return g&&console.log("Not a valid JPEG"),!1;for(var r=2,n=e.byteLength,i=function(e,t){return 56===e.getUint8(t)&&66===e.getUint8(t+1)&&73===e.getUint8(t+2)&&77===e.getUint8(t+3)&&4===e.getUint8(t+4)&&4===e.getUint8(t+5)};n>r;){if(i(t,r)){var o=t.getUint8(r+7);o%2!==0&&(o+=1),0===o&&(o=4);var a=r+8+o,u=t.getUint16(r+6+o);return s(e,a,u)}r++}}function s(e,t,r){for(var n,i,o,a,s,u=new DataView(e),c={},l=t;t+r>l;)28===u.getUint8(l)&&2===u.getUint8(l+1)&&(a=u.getUint8(l+2),a in S&&(o=u.getInt16(l+3),s=o+5,i=S[a],n=h(u,l+5,o),c.hasOwnProperty(i)?c[i]instanceof Array?c[i].push(n):c[i]=[c[i],n]:c[i]=n)),l++;return c}function u(e,t,r,n,i){var o,a,s,u=e.getUint16(r,!i),h={};for(s=0;u>s;s++)o=r+12*s+2,a=n[e.getUint16(o,!i)],!a&&g&&console.log("Unknown tag: "+e.getUint16(o,!i)),h[a]=c(e,o,t,r,i);return h}function c(e,t,r,n,i){var o,a,s,u,c,l,g=e.getUint16(t+2,!i),f=e.getUint32(t+4,!i),d=e.getUint32(t+8,!i)+r;switch(g){case 1:case 7:if(1==f)return e.getUint8(t+8,!i);for(o=f>4?d:t+8,a=[],u=0;f>u;u++)a[u]=e.getUint8(o+u);return a;case 2:return o=f>4?d:t+8,h(e,o,f-1);case 3:if(1==f)return e.getUint16(t+8,!i);for(o=f>2?d:t+8,a=[],u=0;f>u;u++)a[u]=e.getUint16(o+2*u,!i);return a;case 4:if(1==f)return e.getUint32(t+8,!i);for(a=[],u=0;f>u;u++)a[u]=e.getUint32(d+4*u,!i);return a;case 5:if(1==f)return c=e.getUint32(d,!i),l=e.getUint32(d+4,!i),s=new Number(c/l),s.numerator=c,s.denominator=l,s;for(a=[],u=0;f>u;u++)c=e.getUint32(d+8*u,!i),l=e.getUint32(d+4+8*u,!i),a[u]=new Number(c/l),a[u].numerator=c,a[u].denominator=l;return a;case 9:if(1==f)return e.getInt32(t+8,!i);for(a=[],u=0;f>u;u++)a[u]=e.getInt32(d+4*u,!i);return a;case 10:if(1==f)return e.getInt32(d,!i)/e.getInt32(d+4,!i);for(a=[],u=0;f>u;u++)a[u]=e.getInt32(d+8*u,!i)/e.getInt32(d+4+8*u,!i);return a}}function h(e,t,r){var i="";for(n=t;n<t+r;n++)i+=String.fromCharCode(e.getUint8(n));return i}function l(e,t){if("Exif"!=h(e,t,4))return g&&console.log("Not valid EXIF data! "+h(e,t,4)),!1;var r,n,i,o,a,s=t+6;if(18761==e.getUint16(s))r=!1;else{if(19789!=e.getUint16(s))return g&&console.log("Not valid TIFF data! (no 0x4949 or 0x4D4D)"),!1;r=!0}if(42!=e.getUint16(s+2,!r))return g&&console.log("Not valid TIFF data! (no 0x002A)"),!1;var c=e.getUint32(s+4,!r);if(8>c)return g&&console.log("Not valid TIFF data! (First offset less than 8)",e.getUint32(s+4,!r)),!1;if(n=u(e,s,s+c,m,r),n.ExifIFDPointer){o=u(e,s,s+n.ExifIFDPointer,p,r);for(i in o){switch(i){case"LightSource":case"Flash":case"MeteringMode":case"ExposureProgram":case"SensingMethod":case"SceneCaptureType":case"SceneType":case"CustomRendered":case"WhiteBalance":case"GainControl":case"Contrast":case"Saturation":case"Sharpness":case"SubjectDistanceRange":case"FileSource":o[i]=w[i][o[i]];break;case"ExifVersion":case"FlashpixVersion":o[i]=String.fromCharCode(o[i][0],o[i][1],o[i][2],o[i][3]);break;case"ComponentsConfiguration":o[i]=w.Components[o[i][0]]+w.Components[o[i][1]]+w.Components[o[i][2]]+w.Components[o[i][3]]}n[i]=o[i]}}if(n.GPSInfoIFDPointer){a=u(e,s,s+n.GPSInfoIFDPointer,v,r);for(i in a){switch(i){case"GPSVersionID":a[i]=a[i][0]+"."+a[i][1]+"."+a[i][2]+"."+a[i][3]}n[i]=a[i]}}return n}var g=!1,f=this,d=function(e){return e instanceof d?e:this instanceof d?void(this.EXIFwrapped=e):new d(e)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=d),exports.EXIF=d):f.EXIF=d;var p=d.Tags={36864:"ExifVersion",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37500:"MakerNote",37510:"UserComment",40964:"RelatedSoundFile",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBias",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37396:"SubjectArea",37386:"FocalLength",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRation",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",40965:"InteroperabilityIFDPointer",42016:"ImageUniqueID"},m=d.TiffTags={256:"ImageWidth",257:"ImageHeight",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer",40965:"InteroperabilityIFDPointer",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",274:"Orientation",277:"SamplesPerPixel",284:"PlanarConfiguration",530:"YCbCrSubSampling",531:"YCbCrPositioning",282:"XResolution",283:"YResolution",296:"ResolutionUnit",273:"StripOffsets",278:"RowsPerStrip",279:"StripByteCounts",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",301:"TransferFunction",318:"WhitePoint",319:"PrimaryChromaticities",529:"YCbCrCoefficients",532:"ReferenceBlackWhite",306:"DateTime",270:"ImageDescription",271:"Make",272:"Model",305:"Software",315:"Artist",33432:"Copyright"},v=d.GPSTags={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential"},w=d.StringValues={ExposureProgram:{0:"Not defined",1:"Manual",2:"Normal program",3:"Aperture priority",4:"Shutter priority",5:"Creative program",6:"Action program",7:"Portrait mode",8:"Landscape mode"},MeteringMode:{0:"Unknown",1:"Average",2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"},LightSource:{0:"Unknown",1:"Daylight",2:"Fluorescent",3:"Tungsten (incandescent light)",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 - 5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",24:"ISO studio tungsten",255:"Other"},Flash:{0:"Flash did not fire",1:"Flash fired",5:"Strobe return light not detected",7:"Strobe return light detected",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",95:"Flash fired, auto mode, return light detected, red-eye reduction mode"},SensingMethod:{1:"Not defined",2:"One-chip color area sensor",3:"Two-chip color area sensor",4:"Three-chip color area sensor",5:"Color sequential area sensor",7:"Trilinear sensor",8:"Color sequential linear sensor"},SceneCaptureType:{0:"Standard",1:"Landscape",2:"Portrait",3:"Night scene"},SceneType:{1:"Directly photographed"},CustomRendered:{0:"Normal process",1:"Custom process"},WhiteBalance:{0:"Auto white balance",1:"Manual white balance"},GainControl:{0:"None",1:"Low gain up",2:"High gain up",3:"Low gain down",4:"High gain down"},Contrast:{0:"Normal",1:"Soft",2:"Hard"},Saturation:{0:"Normal",1:"Low saturation",2:"High saturation"},Sharpness:{0:"Normal",1:"Soft",2:"Hard"},SubjectDistanceRange:{0:"Unknown",1:"Macro",2:"Close view",3:"Distant view"},FileSource:{3:"DSC"},Components:{0:"",1:"Y",2:"Cb",3:"Cr",4:"R",5:"G",6:"B"}},S={120:"caption",110:"credit",25:"keywords",55:"dateCreated",80:"byline",85:"bylineTitle",122:"captionWriter",105:"headline",116:"copyright",15:"category"};d.getData=function(t,r){return(t instanceof Image||t instanceof HTMLImageElement)&&!t.complete?!1:(e(t)?r&&r.call(t):i(t,r),!0)},d.getTag=function(t,r){return e(t)?t.exifdata[r]:void 0},d.getAllTags=function(t){if(!e(t))return{};var r,n=t.exifdata,i={};for(r in n)n.hasOwnProperty(r)&&(i[r]=n[r]);return i},d.pretty=function(t){if(!e(t))return"";var r,n=t.exifdata,i="";for(r in n)n.hasOwnProperty(r)&&(i+="object"==typeof n[r]?n[r]instanceof Number?r+" : "+n[r]+" ["+n[r].numerator+"/"+n[r].denominator+"]\r\n":r+" : ["+n[r].length+" values]\r\n":r+" : "+n[r]+"\r\n");return i},d.readFromBinaryFile=function(e){return o(e)},"function"==typeof define&&define.amd&&define("exif-js",[],function(){return d})}.call(this),function(){function e(e){var t=e.naturalWidth,r=e.naturalHeight;if(t*r>1048576){var n=document.createElement("canvas");n.width=n.height=1;var i=n.getContext("2d");return i.drawImage(e,-t+1,0),0===i.getImageData(0,0,1,1).data[3]}return!1}function t(e,t,r){var n=document.createElement("canvas");n.width=1,n.height=r;var i=n.getContext("2d");i.drawImage(e,0,0);for(var o=i.getImageData(0,0,1,r).data,a=0,s=r,u=r;u>a;){var c=o[4*(u-1)+3];0===c?s=u:a=u,u=s+a>>1}var h=u/r;return 0===h?1:h}function r(e,t,r){var i=document.createElement("canvas");return n(e,i,t,r),i.toDataURL("image/jpeg",t.quality||.8)}function n(r,n,o,a){var s=r.naturalWidth,u=r.naturalHeight;if(s+u){var c=o.width,h=o.height,l=n.getContext("2d");l.save(),i(n,l,c,h,o.orientation);var g=e(r);g&&(s/=2,u/=2);var f=1024,d=document.createElement("canvas");d.width=d.height=f;for(var p=d.getContext("2d"),m=a?t(r,s,u):1,v=Math.ceil(f*c/s),w=Math.ceil(f*h/u/m),S=0,y=0;u>S;){for(var b=0,x=0;s>b;)p.clearRect(0,0,f,f),p.drawImage(r,-b,-S),l.drawImage(d,0,0,f,f,x,y,v,w),b+=f,x+=v;S+=f,y+=w}l.restore(),d=p=null}}function i(e,t,r,n,i){switch(i){case 5:case 6:case 7:case 8:e.width=n,e.height=r;break;default:e.width=r,e.height=n}switch(i){case 2:t.translate(r,0),t.scale(-1,1);break;case 3:t.translate(r,n),t.rotate(Math.PI);break;case 4:t.translate(0,n),t.scale(1,-1);break;case 5:t.rotate(.5*Math.PI),t.scale(1,-1);break;case 6:t.rotate(.5*Math.PI),t.translate(0,-n);break;case 7:t.rotate(.5*Math.PI),t.translate(r,-n),t.scale(-1,1);break;case 8:t.rotate(-.5*Math.PI),t.translate(-r,0)}}function o(e){if(window.Blob&&e instanceof Blob){if(!a)throw Error("No createObjectURL function found to create blob url");var t=new Image;t.src=a.createObjectURL(e),this.blob=e,e=t}if(!e.naturalWidth&&!e.naturalHeight){var r=this;e.onload=e.onerror=function(){var e=r.imageLoadListeners;if(e){r.imageLoadListeners=null;for(var t=0,n=e.length;n>t;t++)e[t]()}},this.imageLoadListeners=[]}this.srcImage=e}var a=window.URL&&window.URL.createObjectURL?window.URL:window.webkitURL&&window.webkitURL.createObjectURL?window.webkitURL:null;o.prototype.render=function(e,t,i){if(this.imageLoadListeners){var o=this;return void this.imageLoadListeners.push(function(){o.render(e,t,i)})}t=t||{};var s=this.srcImage.naturalWidth,u=this.srcImage.naturalHeight,c=t.width,h=t.height,l=t.maxWidth,g=t.maxHeight,f=!this.blob||"image/jpeg"===this.blob.type;c&&!h?h=u*c/s<<0:h&&!c?c=s*h/u<<0:(c=s,h=u),l&&c>l&&(c=l,h=u*c/s<<0),g&&h>g&&(h=g,c=s*h/u<<0);var d={width:c,height:h};for(var p in t)d[p]=t[p];var m=e.tagName.toLowerCase();"img"===m?e.src=r(this.srcImage,d,f):"canvas"===m&&n(this.srcImage,e,d,f),"function"==typeof this.onrender&&this.onrender(e),i&&i(),this.blob&&(this.blob=null,a.revokeObjectURL(this.srcImage.src))},"function"==typeof define&&define.amd?define([],function(){return o}):"object"==typeof exports?module.exports=o:this.MegaPixImage=o}(),function(){var e=function(e){this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),document.body.appendChild(this.canvas),this.width=this.canvas.width=e.width,this.height=this.canvas.height=e.height,this.context.drawImage(e,0,0,this.width,this.height)};e.prototype.clear=function(){this.context.clearRect(0,0,this.width,this.height)},e.prototype.update=function(e){this.context.putImageData(e,0,0)},e.prototype.getPixelCount=function(){return this.width*this.height},e.prototype.getImageData=function(){return this.context.getImageData(0,0,this.width,this.height)},e.prototype.removeCanvas=function(){this.canvas.parentNode.removeChild(this.canvas)};var t=function(){};if(t.prototype.getColor=function(e,t){var r=this.getPalette(e,5,t),n=r[0];return n},t.prototype.getPalette=function(t,r,i){"undefined"==typeof r&&(r=10),("undefined"==typeof i||1>i)&&(i=10);for(var o,a,s,u,c,h=new e(t),l=h.getImageData(),g=l.data,f=h.getPixelCount(),d=[],p=0;f>p;p+=i)o=4*p,a=g[o+0],s=g[o+1],u=g[o+2],c=g[o+3],c>=125&&(a>250&&s>250&&u>250||d.push([a,s,u]));var m=n.quantize(d,r),v=m?m.palette():null;return h.removeCanvas(),v},!r)var r={map:function(e,t){var r={};return t?e.map(function(e,n){return r.index=n,t.call(r,e)}):e.slice()},naturalOrder:function(e,t){return t>e?-1:e>t?1:0},sum:function(e,t){var r={};return e.reduce(t?function(e,n,i){return r.index=i,e+t.call(r,n)}:function(e,t){return e+t},0)},max:function(e,t){return Math.max.apply(null,t?r.map(e,t):e)}};var n=function(){function e(e,t,r){return(e<<2*c)+(t<<c)+r}function t(e){function t(){r.sort(e),n=!0}var r=[],n=!1;return{push:function(e){r.push(e),n=!1},peek:function(e){return n||t(),void 0===e&&(e=r.length-1),r[e]},pop:function(){return n||t(),r.pop()},size:function(){return r.length},map:function(e){return r.map(e)},debug:function(){return n||t(),r}}}function n(e,t,r,n,i,o,a){var s=this;s.r1=e,s.r2=t,s.g1=r,s.g2=n,s.b1=i,s.b2=o,s.histo=a}function i(){this.vboxes=new t(function(e,t){return r.naturalOrder(e.vbox.count()*e.vbox.volume(),t.vbox.count()*t.vbox.volume())})}function o(t){var r,n,i,o,a=1<<3*c,s=new Array(a);return t.forEach(function(t){n=t[0]>>h,i=t[1]>>h,o=t[2]>>h,r=e(n,i,o),s[r]=(s[r]||0)+1}),s}function a(e,t){var r,i,o,a=1e6,s=0,u=1e6,c=0,l=1e6,g=0;return e.forEach(function(e){r=e[0]>>h,i=e[1]>>h,o=e[2]>>h,a>r?a=r:r>s&&(s=r),u>i?u=i:i>c&&(c=i),l>o?l=o:o>g&&(g=o)}),new n(a,s,u,c,l,g,t)}function s(t,n){function i(e){var t,r,i,o,a,s=e+"1",u=e+"2",h=0;for(c=n[s];c<=n[u];c++)if(p[c]>d/2){for(i=n.copy(),o=n.copy(),t=c-n[s],r=n[u]-c,a=r>=t?Math.min(n[u]-1,~~(c+r/2)):Math.max(n[s],~~(c-1-t/2));!p[a];)a++;for(h=m[a];!h&&p[a-1];)h=m[--a];return i[u]=a,o[s]=i[u]+1,[i,o]}}if(n.count()){var o=n.r2-n.r1+1,a=n.g2-n.g1+1,s=n.b2-n.b1+1,u=r.max([o,a,s]);if(1==n.count())return[n.copy()];var c,h,l,g,f,d=0,p=[],m=[];if(u==o)for(c=n.r1;c<=n.r2;c++){for(g=0,h=n.g1;h<=n.g2;h++)for(l=n.b1;l<=n.b2;l++)f=e(c,h,l),g+=t[f]||0;d+=g,p[c]=d}else if(u==a)for(c=n.g1;c<=n.g2;c++){for(g=0,h=n.r1;h<=n.r2;h++)for(l=n.b1;l<=n.b2;l++)f=e(h,c,l),g+=t[f]||0;d+=g,p[c]=d}else for(c=n.b1;c<=n.b2;c++){for(g=0,h=n.r1;h<=n.r2;h++)for(l=n.g1;l<=n.g2;l++)f=e(h,l,c),g+=t[f]||0;d+=g,p[c]=d}return p.forEach(function(e,t){m[t]=d-e}),i(u==o?"r":u==a?"g":"b")}}function u(e,n){function u(e,t){for(var r,n=1,i=0;l>i;)if(r=e.pop(),r.count()){var o=s(c,r),a=o[0],u=o[1];if(!a)return;if(e.push(a),u&&(e.push(u),n++),n>=t)return;if(i++>l)return}else e.push(r),i++}if(!e.length||2>n||n>256)return!1;var c=o(e),h=0;c.forEach(function(){h++});var f=a(e,c),d=new t(function(e,t){return r.naturalOrder(e.count(),t.count())});d.push(f),u(d,g*n);for(var p=new t(function(e,t){return r.naturalOrder(e.count()*e.volume(),t.count()*t.volume())});d.size();)p.push(d.pop());u(p,n-p.size());for(var m=new i;p.size();)m.push(p.pop());return m}var c=5,h=8-c,l=1e3,g=.75;return n.prototype={volume:function(e){var t=this;return(!t._volume||e)&&(t._volume=(t.r2-t.r1+1)*(t.g2-t.g1+1)*(t.b2-t.b1+1)),t._volume},count:function(t){var r=this,n=r.histo;if(!r._count_set||t){var i,o,a,s=0;for(i=r.r1;i<=r.r2;i++)for(o=r.g1;o<=r.g2;o++)for(a=r.b1;a<=r.b2;a++)index=e(i,o,a),s+=n[index]||0;r._count=s,r._count_set=!0}return r._count},copy:function(){var e=this;return new n(e.r1,e.r2,e.g1,e.g2,e.b1,e.b2,e.histo)},avg:function(t){var r=this,n=r.histo;if(!r._avg||t){var i,o,a,s,u,h=0,l=1<<8-c,g=0,f=0,d=0;for(o=r.r1;o<=r.r2;o++)for(a=r.g1;a<=r.g2;a++)for(s=r.b1;s<=r.b2;s++)u=e(o,a,s),i=n[u]||0,h+=i,g+=i*(o+.5)*l,f+=i*(a+.5)*l,d+=i*(s+.5)*l;h?r._avg=[~~(g/h),~~(f/h),~~(d/h)]:r._avg=[~~(l*(r.r1+r.r2+1)/2),~~(l*(r.g1+r.g2+1)/2),~~(l*(r.b1+r.b2+1)/2)]}return r._avg},contains:function(e){var t=this,r=e[0]>>h;return gval=e[1]>>h,bval=e[2]>>h,r>=t.r1&&r<=t.r2&&gval>=t.g1&&gval<=t.g2&&bval>=t.b1&&bval<=t.b2}},i.prototype={push:function(e){this.vboxes.push({vbox:e,color:e.avg()})},palette:function(){return this.vboxes.map(function(e){return e.color})},size:function(){return this.vboxes.size()},map:function(e){for(var t=this.vboxes,r=0;r<t.size();r++)if(t.peek(r).vbox.contains(e))return t.peek(r).color;return this.nearest(e)},nearest:function(e){for(var t,r,n,i=this.vboxes,o=0;o<i.size();o++)r=Math.sqrt(Math.pow(e[0]-i.peek(o).color[0],2)+Math.pow(e[1]-i.peek(o).color[1],2)+Math.pow(e[2]-i.peek(o).color[2],2)),(t>r||void 0===t)&&(t=r,n=i.peek(o).color);return n},forcebw:function(){var e=this.vboxes;e.sort(function(e,t){return r.naturalOrder(r.sum(e.color),r.sum(t.color))});var t=e[0].color;t[0]<5&&t[1]<5&&t[2]<5&&(e[0].color=[0,0,0]);var n=e.length-1,i=e[n].color;i[0]>251&&i[1]>251&&i[2]>251&&(e[n].color=[255,255,255])}},{quantize:u}}();"function"==typeof define&&define.amd?define([],function(){return t}):"object"==typeof exports?module.exports=t:this.ColorThief=t}.call(this);
